### 一、简介

本篇文章会介绍DNS解析，web请求是如何发送出去，负载均衡功能如何工作，路由交换的映射功能大致的做法，上上签混合云中各类型资源是从哪里获取。

介绍这些的主要目的是为了让同事们在排查客户问题中能更顺畅一些，比如请求中出现could't reslove hostname大概率是DNS解析的问题、比如浏览器明显的提示找不到网址、也是DNS问题。比如公网访问上上签混合云合同预览不能查看合同内容，这种就可能是从公网访问客户本地化服务的dns、负载均衡或内外网映射、客户防火墙出现了问题。



### 二、dns解析

​		含义：DNS( Domain Name System)是“域名系统”的英文缩写，是一种组织成域层次结构的计算机和网络服务命名系统，它用于TCP/IP网络，它所提供的服务是用来将主机名和域名转换为IP地址的工作。

​		作用：DNS是应用层协议，事实上他是为其他应用层协议工作的，包括不限于HTTP和SMTP以及FTP，用于将用户提供的主机名解析为ip地址。

​		DNS服务器一般分三种，根DNS服务器（.），顶级DNS服务器(cn、org、edu、jp、hk等)，权威DNS服务器，如下图：

![img](网络是如何连接.assets/79b9fd2666e989ab24024966632ae63f_1440w.jpg)

![img](网络是如何连接.assets/858807-20170820123443521-1502085421.png)

​		DNS查询方式：递归查询和迭代查询；

​		递归查询： 如果主机所询问的本地域名服务器不知道被查询的域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其它根域名服务器继续发出查询请求报文(即替主机继续查询)，而不是让主机自己进行下一步查询。

​		迭代查询：顶级域名服务器在收到本地域名服务器的查询请求后，要么给出所要查询的IP地址，要么告诉本地服务器下一步应当向哪一个权限域名服务器进行查询。然后让本地服务器进行后续的查询。根域名服务器通常是把自己知道的顶级域名服务器的IP地址告诉本地域名服务器，让本地域名服务器再向顶级域名服务器查询。  最后，知道了所要解析的IP地址或报错，然后把这个结果返回给发起查询的主机

​		DNS查询过程：如下图

​	![preview](网络是如何连接.assets/7fcd81756bdc8b52ade0531402c43e43_r.jpg)

​	DNS内外网解析：

![image-20210824145948035](网络是如何连接.assets/image-20210824145948035.png)

​		访问方式：1、内外网用户都通过公网ip访问，服务器通过内网访问，此时需要在公网dns做解析，解析出公网IP，内网服务通过内网ip的方式访问。

​							2、内网用户通过内网访问，公网用户通过公网访问，服务器通过内网访问，此时需要内外网dns分别做解析；

​							3、只允许用户内网访问，比如通过vpn的内网访问，此时可以在内网/公网dns做解析，解析出内网ip；



三、请求是如何发送的

​		从网上找到一个网络请求的过程图如下：

![img](网络是如何连接.assets/webp)

​		将上图用文字再描述一下：请求域名-->通过dns解析出IP地址-->请求ip地址获取资源-->请求通过防火墙-->请求到达SLB（nginx）-->请求到达java服务器-->请求被处理并返回处理信息-->返回请求到SLB（nginx）-->请求返回通过防火墙-->请求返回到用户

​		其中“请求IP地址获取资源”这一步中，在请求域名访问资源时，真是的去跟客户服务器做交互是通过IP地址，这步骤中，发送http请求的请求头中包含host信息；

![image-20210824151953893](网络是如何连接.assets/image-20210824151953893.png)



### 四、负载均衡对外提供服务

​		运维中常见的负载均衡服务开源工具有nginx和haproxy，公有云服务商提供的负载均衡服务是SLB，不管是nginx/haproxy还是SLB，他们的使用方法以及原理大致都相同，并且他们都可以提供https的功能。

​		常见的提供负载均衡服务有两种：单独负载均衡和共用负载均衡，以云平台SLB为例，单独负载均衡是单独购买一个SLB服务，共用负载均衡是和其他服务一起共用一个SLB。

​		不管是ECS主机安装nginx或haproxy，还是使用SLB，他们都能拥有两个ip：内网IP和公网IP；通过内外网访问，请求都会到达同一个负载均衡去处理，如下图：

![image-20210824165924706](网络是如何连接.assets/image-20210824165924706.png)

### 五、使用防火墙端口映射对外提供服务

​		防火墙映射，可以做端口的映射，公网的某端口的访问请求都转到内网某端口。另一种是ip的映射，公网ip所有请求都转交给内网ip处理。

![image-20210824171233677](网络是如何连接.assets/image-20210824171233677.png)

### 六、上上签混合云合同数据流转

​		在这里，主要要考虑的是混合云上上签jar服务器与上上签之前的通信，以及混合云客户的用户在签署合同查看合同时候的数据流转通信。在这里可以看到，用户手机访问合同签署的时候，前端的一些资源请求是请求上上签的需要用的的合同文件的渲染则是从客户的混合云jar服务中获取的。所以，这里一定要注意dns、防火墙等问题。

![image-20210824174110639](网络是如何连接.assets/image-20210824174110639.png)

